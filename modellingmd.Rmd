---
title: "Latent Bus Ridership Demand Modelling of El Paso, Texas"
author: "Charlie Huemmler, Yingxue Ou, Jack Rummler"
date: "2023-03-26"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
    pdf_document: default
    theme: journal
---


```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE,
  warning=FALSE,
  message=FALSE,
  results='hide')

library(sf)
library(tidyverse)
library(tidycensus)
library(lehdr)
library(here)
library(cowplot)
library(paletteer)
library(scales)
library(ggpubr)
#devtools::install_github("jamgreen/lehdr")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

census_api_key("746ea8916547306ae2abf2aafe059e1a1b70b98a", overwrite = TRUE)
data_folder <- file.path(
  here() %>% 
    dirname(), 'data')

mapTheme <- theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  ) 

plotTheme <- theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    #axis.ticks = element_blank(),
    panel.background = element_blank(),
    #axis.title = element_blank(),
    #axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  ) 

sf::sf_use_s2(FALSE)
options(scipen=999)
```



```{r get el paso census data}
censusvars <- c("B01001_001E", # ACS total Pop estimate
              "B25002_001E", # Estimate of total housing units
              "B25002_003E", # Number of vacant housing units
              "B19013_001E", # Median HH Income ($)
              "B02001_002E", # People describing themselves as "white alone"
              "B06009_006E",
              "B01001I_001E", # Hispanic or Latino 
              "B08014_001E",
              "B09001_002E", # Population under 18
              "B10052_002E", # Disability
              "B25075_001E", # House value
              "B08014_002E") # No vehicle available


elpaso <- get_acs(geography = "tract",
                             year = 2020, 
                             variables = censusvars, 
                             geometry = T,
                             state = "TX", 
                             county = "El Paso", 
                             output = "wide") 


elpaso <- elpaso %>%
  rename(
    total_pop.2020 = B01001_001E,
    total_HU.2020 = B25002_001E,
    total_vacant.2020 = B25002_003E,
    med_HH_Income.2020 = B19013_001E,
    total_White.2020 = B02001_002E,
    total_GradDeg.2020 = B06009_006E,
    total_HL.2020 = B01001I_001E,
    noV.2020 = B08014_002E,
    under18.2020 = B09001_002E,
    disAb.2020 = B10052_002E,
    Value = B25075_001E
  ) %>%
    mutate(vacancyPct.2020 = total_vacant.2020/total_HU.2020,
         pctWhite.2020 = total_White.2020/total_pop.2020,
         pctHL.2020 = total_HL.2020/total_pop.2020,
         pctNV.2020 = noV.2020/total_HU.2020*100,
         pctUnder18.2020 = under18.2020/total_pop.2020,
         pctDisAb.2020 = disAb.2020/total_pop.2020,
         area_sqmile = st_area(geometry)/2590000
         ) %>%
  st_as_sf(crs = 4269) 
```

```{r make_hex_net}
busroutes <-  read_sf(paste(data_folder, "/transit_lines.geojson", sep = '')) %>% st_transform(crs = 4269)

roads <- read_sf(paste(data_folder, "/EPCenterline.shp", sep = '')) %>% st_transform(crs = 4269)

#ask alex about this map


futureLU <- read_sf(paste(data_folder, "/FutureLandUse.shp", sep = '')) %>% st_transform(crs = 4269)  

futureLU_crop <- futureLU %>% st_crop(y = st_bbox(busroutes))

# ggplot()+
#    geom_sf(data = futureLU, aes(fill = COMMENTS))+
#    geom_sf(data = roads)+
#    geom_sf(data = busroutes, color = 'red')
 


excludeLU <- c("Fort Bliss Military","Fort Bliss Mixed Use (Airport)","Preserve","Industrial and/or Railyards","Remote","Military Reserve")


exclude_area <-  futureLU_crop %>% filter(COMMENTS %in% excludeLU) %>% st_union()



elpaso_outline <- elpaso %>% st_union() %>% st_sf() %>% st_crop(y = st_bbox(busroutes)) %>% st_difference(exclude_area)


hex <- st_make_grid(elpaso_outline, cellsize = .0075, crs = 4269,  square = F) %>% st_sf() 

hex <- hex[elpaso_outline,] %>%
  mutate(uniqueID = rownames(.))

ggplot(hex)+
  geom_sf()

```



```{r target variable into net}
data_folder <- file.path(here() %>% dirname(), 'data')

riderstops_sf <- read_csv(paste(data_folder, "/riderstops1.csv", sep = '')) %>%
  filter(!is.na(stop_lat)) %>%
  st_as_sf(coords = c('stop_lon', 'stop_lat'), crs = 4269) 

stop_riders_agg <- riderstops_sf %>% group_by(TP) %>% summarise(ridership = sum(Ons) + sum(Offs))


ridership_net <- stop_riders_agg %>% 
  dplyr::select(ridership) %>% 
  aggregate(., hex, sum) %>%
  mutate(ridership = replace_na(ridership, 0),
         uniqueID = rownames(.))

```



```{r create census hex}

#get lhodes work place data
tx_work <- grab_lodes(state = "tx", year = 2019, lodes_type = "wac", job_type = "JT01", 
                    segment = "S000", state_part = "main", agg_geo = "tract") %>% 
  rename(total_jobs = C000,
         age_29_or_younger = CA01,
         age_30_to_54 = CA02,
         age_55_or_older = CA03,
         monthly_income_1250_or_less = CE01,
         monthly_income_1251_to_3333 = CE02,
         monthly_income_3334_or_more = CE03,
         NAICS11 = CNS01,
         NAICS21 = CNS02,
         NAICS22 = CNS03,
         NAICS23 = CNS04,
         NAICS31_33 = CNS05,
         NAICS42 = CNS06,
         NAICS44_46 = CNS07,
         NAICS48_49 = CNS08,
         NAICS51 = CNS09,
         NAICS52 = CNS10,
         NAICS53 = CNS11,
         NAICS54 = CNS12,
         NAICS55 = CNS13,
         NAICS56 = CNS14,
         NAICS61 = CNS15,
         NAICS62 = CNS16,
         NAICS71 = CNS17,
         NAICS72 = CNS18,
         NAICS81 = CNS19,
         NAICS92 = CNS20,
         white_work = CR01,
         black_work = CR02,
         native_american_work = CR03,
         asian_work = CR04,
         pacific_work = CR05,
         mixed_race_work = CR07,
         not_hispanic_work = CT01,
         hispanic_work = CT02,
         male_work = CS01,
         female_work = CS02) %>% select(-starts_with("C"))
#merge to census tracts data
elpaso_work <- left_join(elpaso, tx_work, by = c('GEOID' = 'w_tract')) %>% st_sf() %>%
  mutate_at(colnames(tx_work)[4:length(colnames(tx_work))], funs(as.numeric(./area_sqmile)))

#add to hex
census_hex <- hex %>% st_centroid() %>% st_join(elpaso_work, join=st_within) %>% 
  st_drop_geometry() %>% 
  full_join(., hex) %>% st_sf()


```

```{r}
#tring another way

#hex_join <- st_intersection(hex, elpaso_work) %>% group_by(uniqueID) %>% 
 # summarize()

#ggplot(hex_join)+
 # geom_sf()
```


```{r walkabiity features}
walkscore <- read_sf(paste(data_folder, "/nwi_bg.geojson", sep = ''))

walk_hex <- hex %>% st_centroid() %>% st_join(walkscore, join=st_within)

```

```{r make final hex}
final_hex <- left_join(ridership_net, st_drop_geometry(census_hex), by = "uniqueID") %>% 
  left_join(st_drop_geometry(walk_hex), by = "uniqueID") %>% replace(is.na(.), 0)

```

```{r feature mapping and scatterplot}



inde_var <- "total_jobs"



scat <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(inde_var)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs",inde_var), y = 'Ridership', x = inde_var)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')

map <- final_hex %>%
  ggplot()+
  geom_sf(aes(fill = get(inde_var)), color =NA)+
  paletteer::scale_fill_paletteer_c("grDevices::Red-Yellow", -1, labels= comma)+
  labs(fill = inde_var)+
  theme(legend.position = 'right')+
  mapTheme
  
plot_grid(scat, map, rel_widths = c(1,1.3))
```

```{r modeling}

lhodes_vars <-c(colnames(tx_work)[5:length(colnames(tx_work))])
census_vars <- c()
walkscore_vars <- c()

input <- final_hex %>% select(ridership, lhodes_vars) %>% st_drop_geometry()

m1 <- lm(formula = ridership ~ .,
         data = input)

m1 %>% summary()

```


