---
title: "Latent Bus Ridership Demand Modelling of El Paso, Texas"
author: "Charlie Huemmler, Yingxue Ou, Jack Rummler"
date: "2023-03-26"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
    pdf_document: default
    theme: journal
---


```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE,
  warning=FALSE,
  message=FALSE,
  results='hide')

library(sf)
library(tidyverse)
library(tidycensus)
library(lehdr)
library(here)
library(cowplot)
library(paletteer)
library(scales)
library(ggpubr)
#devtools::install_github("jamgreen/lehdr")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

census_api_key("746ea8916547306ae2abf2aafe059e1a1b70b98a", overwrite = TRUE)
data_folder <- file.path(
  here() %>% 
    dirname(), 'data')

mapTheme <- theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  ) 

plotTheme <- theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    #axis.ticks = element_blank(),
    panel.background = element_blank(),
    #axis.title = element_blank(),
    #axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  ) 

sf::sf_use_s2(FALSE)
options(scipen=999)
```



```{r get el paso census data}
censusvarsEP <- c(
  "B01001_001E", # ACS total Pop estimate
  "B01001I_001E", # Population - Hispanic or Latino 
  "B02001_002E", # Population - White alone
  "B02001_003E", # Population - Black or African American alone
  "B02001_004E", # Population - American Indian and Alaska Native alone
  "B02001_005E", # Population - Asian alone
  "B02001_006E", # Population - Native Hawaiian and Other Pacific Islander alone
  "B02001_007E", # Population - Some other race alone
  "B02001_008E", # Population - Two or more races
  "B19013_001E", # Median household income in the past 12 months (in 2019 inflation-adjusted dollars)
  "B25001_001E", # Total housing units
  "B25002_002E", # Occupancy status - Occupied housing units
  "B25024_001E", # Gross rent as a percentage of household income in the past 12 months
  "B25044_001E", # Vehicles available
  "B28005_001E", # Means of transportation to work by age
  "B28010_001E", # Commuting time to work (in minutes)
  "B10052_002E", # Disability
  "B06009_002E", # Less than high school
  "B06009_003E", # High School
  "B06009_004E", # Associates or equivalent
  "B06009_005E", # Bachelors
  "B06009_006E" # Graduate or prof. degree
)

elpaso <- get_acs(geography = "tract",
                             year = 2020, 
                             variables = censusvarsEP, 
                             geometry = T,
                             state = "TX", 
                             county = "El Paso", 
                             output = "wide") 

#vec to not divide by sqkm
dontdiv<- c("GEOID","NAME","medHHInc","grossRentPerInc","commuteToWork","geometry","area_sqmile")

elpaso <- elpaso %>%
rename(
  totalPop = B01001_001E, 
  hlPop = B01001I_001E, 
  whitePop = B02001_002E, 
  blackPop = B02001_003E,
  aiPop = B02001_004E,
  asianPop = B02001_005E,
  nhPop = B02001_006E,
  otherRacePop = B02001_007E,
  twoPlusRacePop = B02001_008E,
  medHHInc = B19013_001E,
  totalHU = B25001_001E, 
  occupiedHU = B25002_002E, 
  grossRentPerInc = B25024_001E, 
  transByAge = B28005_001E,
  commuteToWork = B28010_001E,
  lessThanHS = B06009_002E,
  highSchool = B06009_003E,
  associatesDeg = B06009_004E,
  bachelorDeg = B06009_005E,
  professionalDeg = B06009_006E,
  disability = B10052_002E) %>%
    mutate(area_sqmile = st_area(geometry)/2590000
         ) %>%  st_as_sf(crs = 4269) %>%
  mutate_at(vars(-dontdiv), funs(as.numeric(./area_sqmile)))


```

```{r make_hex_net}
busroutes <-  read_sf(paste(data_folder, "/transit_lines.geojson", sep = '')) %>% st_transform(crs = 4269)

roads <- read_sf(paste(data_folder, "/EPCenterline.shp", sep = '')) %>% st_transform(crs = 4269)

#ask alex about this map


futureLU <- read_sf(paste(data_folder, "/FutureLandUse.shp", sep = '')) %>% st_transform(crs = 4269)  

futureLU_crop <- futureLU %>% st_crop(y = st_bbox(busroutes))

# ggplot()+
#    geom_sf(data = futureLU, aes(fill = COMMENTS))+
#    geom_sf(data = roads)+
#    geom_sf(data = busroutes, color = 'red')
 


excludeLU <- c("Fort Bliss Military","Fort Bliss Mixed Use (Airport)","Preserve","Industrial and/or Railyards","Remote","Military Reserve")


exclude_area <-  futureLU_crop %>% filter(COMMENTS %in% excludeLU) %>% st_union()



elpaso_outline <- elpaso %>% st_union() %>% st_sf() %>% st_crop(y = st_bbox(busroutes)) %>% st_difference(exclude_area)


hex <- st_make_grid(elpaso_outline, cellsize = .01, crs = 4269,  square = F) %>% st_sf() 

hex <- hex[elpaso_outline,] %>%
  mutate(uniqueID = rownames(.))

ggplot(hex)+
  geom_sf()

```



```{r target variable into net}
data_folder <- file.path(here() %>% dirname(), 'data')

riderstops_sf <- read_csv(paste(data_folder, "/riderstops1.csv", sep = '')) %>%
  filter(!is.na(stop_lat)) %>%
  st_as_sf(coords = c('stop_lon', 'stop_lat'), crs = 4269) 

stop_riders_agg <- riderstops_sf %>% group_by(TP) %>% summarise(ridership = sum(Ons) + sum(Offs))


ridership_net <- stop_riders_agg %>% 
  dplyr::select(ridership) %>% 
  aggregate(., hex, sum) %>%
  mutate(ridership = replace_na(ridership, 0),
         uniqueID = rownames(.))

```



```{r create census hex}

#https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf

#get lhodes work place data
tx_work <- grab_lodes(state = "tx", year = 2019, lodes_type = "wac", job_type = "JT01", 
                    segment = "S000", state_part = "main", agg_geo = "tract") %>% 
  rename(total_jobs = C000,
         age_29_or_younger = CA01,
         age_30_to_54 = CA02,
         age_55_or_older = CA03,
         monthly_income_1250_or_less = CE01,
         monthly_income_1251_to_3333 = CE02,
         monthly_income_3334_or_more = CE03,
         NAICS11 = CNS01,
         NAICS21 = CNS02,
         NAICS22 = CNS03,
         NAICS23 = CNS04,
         NAICS31_33 = CNS05,
         NAICS42 = CNS06,
         NAICS44_46 = CNS07,
         NAICS48_49 = CNS08,
         NAICS51 = CNS09,
         NAICS52 = CNS10,
         NAICS53 = CNS11,
         NAICS54 = CNS12,
         NAICS55 = CNS13,
         NAICS56 = CNS14,
         NAICS61 = CNS15,
         NAICS62 = CNS16,
         NAICS71 = CNS17,
         NAICS72 = CNS18,
         NAICS81 = CNS19,
         NAICS92 = CNS20,
         white_work = CR01,
         black_work = CR02,
         native_american_work = CR03,
         asian_work = CR04,
         pacific_work = CR05,
         mixed_race_work = CR07,
         not_hispanic_work = CT01,
         hispanic_work = CT02,
         male_work = CS01,
         female_work = CS02) %>% select(-starts_with("C"))
#merge to census tracts data
elpaso_work <- left_join(elpaso, tx_work, by = c('GEOID' = 'w_tract')) %>% st_sf() %>%
  mutate_at(colnames(tx_work)[4:length(colnames(tx_work))], funs(as.numeric(./area_sqmile)))

#add to hex
census_hex <- hex %>% st_centroid() %>% st_join(elpaso_work, join=st_within) %>% 
  st_drop_geometry() %>% 
  full_join(., hex) %>% st_sf()


```

```{r}
#tring another way

#hex_join <- st_intersection(hex, elpaso_work) %>% group_by(uniqueID) %>% 
 # summarize()

#ggplot(hex_join)+
 # geom_sf()
```


```{r walkabiity features}
walkscore <- read_sf(paste(data_folder, "/nwi_bg.geojson", sep = '')) %>% rename(
  totalPop_walk = totalPop
)

walk_hex <- hex %>% st_centroid() %>% st_join(walkscore, join=st_within)

```

```{r make final hex}
final_hex <- left_join(ridership_net, st_drop_geometry(census_hex), by = "uniqueID") %>% 
  left_join(st_drop_geometry(walk_hex), by = "uniqueID") %>% replace(is.na(.), 0)

```

```{r feature mapping and scatterplot}



inde_var <- "total_jobs"



scat <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(inde_var)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs",inde_var), y = 'Ridership', x = inde_var)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')

map <- final_hex %>%
  ggplot()+
  geom_sf(aes(fill = get(inde_var)), color =NA)+
  paletteer::scale_fill_paletteer_c("grDevices::Red-Yellow", -1, labels= comma)+
  labs(fill = inde_var)+
  theme(legend.position = 'right')+
  mapTheme
  
plot_grid(scat, map, rel_widths = c(1,1.3))
```

```{r modeling}

lhodes_vars <-c(colnames(tx_work)[5:length(colnames(tx_work))])
census_vars <- c(colnames(elpaso)[!colnames(elpaso) %in% c("GEOID","NAME")] )
walkscore_vars <- c()

input <- final_hex %>% select(ridership, lhodes_vars, census_vars, walkscore_vars) %>% st_drop_geometry()

m1 <- lm(formula = ridership ~ .,
         data = input)

m1 %>% summary()

```


