---
title: "Forecasting and Predicting Bus Transit Alternatives in El Paso, Texas"
author: "Charlie Huemmler, Yingxue Ou, Jack Rummler"
date: "2023-02-18"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
    pdf_document: default
    theme: journal
---

```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning=FALSE,
                      message=FALSE,
                      results='hide')

library(sf)
library(tidyverse)
library(tidycensus)
library(tigris)
library(boxr)
library(lubridate)
library(here)
library(readxl)
library(gridExtra)
library(scales)
library(viridis)
library(leaflet)
library(ggplotify)
library(ggmap)
library(classInt)
library(rlang)
library(dplyr)
library(maps)
library(plotly)
library(RColorBrewer)
library(htmlwidgets)
library(magick)
library(cowplot)
library(paletteer)
library(stplanr)
library(paletteer)
library(scales)
library(gganimate)
library(transformr)
library(scales)
library(gganimate)
library(glue)
library(ggtext)
library(gapminder)
library(ggplot2)
library(osmdata)
#install.packages("mapview")
library(mapview)
library(sf)
library(tidyverse)
library(tidycensus)
library(lehdr)
library(here)
library(cowplot)
library(paletteer)
library(scales)
library(ggpubr)
library(caret)
library(geojsonio)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

census_api_key("746ea8916547306ae2abf2aafe059e1a1b70b98a", overwrite = TRUE)

data_folder <- file.path(
  here() %>% 
    dirname(), 'data')

mapTheme <- theme(
  text = element_text( color = "black"),
  plot.title = element_text(size = 14,colour = "black"),
  plot.subtitle=element_text(face="italic"),
  plot.caption=element_text(hjust=0),
  axis.ticks = element_blank(),
  panel.background = element_blank(),axis.title = element_blank(),
  axis.text = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_rect(colour = "black", fill=NA, size=2)
) 

plotTheme <- theme(
  text = element_text( color = "black"),
  plot.title = element_text(size = 14,colour = "black"),
  plot.subtitle=element_text(face="italic"),
  plot.caption=element_text(hjust=0),
  #axis.ticks = element_blank(),
  panel.background = element_blank(),
  #axis.title = element_blank(),
  #axis.text = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_rect(colour = "black", fill=NA, size=2)
) 

palette7 <- c("#B8860B", "#2F4F4F", "#8B0000", "#FFD700", "#556B2F", "#ADD8E6", "#FF69B4")


sf::sf_use_s2(FALSE)
options(scipen=999)
```

# Introduction

This project was created by Charlie Huemmler, Yingxue Ou, and Jack Rummler as part of the University of Pennsylvania Master of Urban Spatial Analytics practicum. We would like to thank our client, Alex Hoffman, AICP, of the El Paso Capital Improvements Department for his continual knowledge, eagerness to help, and enthusiasm for this project. We also would like to thank Professors Matthew Harris and Michael Fichman for their invaluable mentorship throughout this project.

## El Paso Context

Sun Metro is the transportation provider in the city of El Paso, Texas. Sun Metro has made several expansions in the past decade, most notably adding four bus rapid transit (BRT) lines, adding the streetcar network, and a new transit center. With many transit agencies in the last decade, there has been a yearly decrease in bus ridership, with a sharp decrease at the start of the COVID-19 pandemic. Now, Sun Metro experiences about 63% of pre-pandemic ridership numbers, but the agency is looking to explore the implications of new bus transit services.

El Paso is the sixth-largest city in Texas located at the far western tip of the state, just immediately north of Ciudad JuÃ¡rez. The city is bounded by the Rio Grande River to the south, the Franklin Mountain Range to the north, and Fort Bliss Military Base to the northeast. The context map below shows the geographical constraints where the Franklin Mountains are represented in light green, Fort Bliss Military Base in dark green, and the Rio Grande River in light blue, overlain on top of population density of the city at a census tract level. As we can see, downtown El Paso is notched in between the mountains and river, with heavy sprawl toward the north and east.

[context_map.png]("C:/Users/jtrum/pennmusa/MUSA8010/repository/context_map.png")

The four BRIO lines currently have the greatest ridership and frequency, accounting for 40% of current ridership. Local bus routes and BRIO lines account for 65% of system ridership. BRIO stops are spaced out every 3/4 to 1 mile, thus the agency is seeking ways to connect local bus transit routes to BRIO lines, accommodating issues associated with the first-mile/last-mile problem. Within new bus transit alternatives, Sun Metro wants to maximize both the revenue of routes as well as the equity and accessibility of bus transit options for El Paso residents.

## Use Case

Our client wishes to understand the ramifications of bus transit alternatives on the existing Sun Metro network based on current ridership counts and demographic variables, built environment characteristics, and spatial effects. We are developing a proof-of-concept, unbiased evaluation framework for Sun Metro transit planners to maximize the social equity and financial profitability outcomes of alternative bus route scenarios.

We are building a predictive model of latent bus transit demand. Within our model, we bake in features related to socio-economic spatial characteristics, built environment features, and spatial lags that affect accessibility to transit. By using features related to system accessibility, we bring an equity approach to the model.

# Data Gathering & Analysis

## Current Bus Network

We utilized road centerline data and bus route data obtained from El Paso's Open Data portal to understand the overall transit system's network. The current network is visually represented below, where roads were depicted in black and the bus network was overlain in orange. We can see that the network coverage extended significantly towards areas surrounding downtown El Paso. However, several neighborhoods located in the eastern part of the city remain unserved by the current transit system. This highlights a potential gap in the transit service coverage of the city and underscores the need for equity considerations in ensuring any El Paso resident has access to transit.

```{r current bus network, warning=FALSE, message=FALSE, results=FALSE}
bus_routes <- read_sf(paste(data_folder, "/BusRoutes.geojson", sep = ''))
road_centerlines <- read_sf(paste(data_folder, '/EPCenterline.shp', sep = ''))

ggplot()+
  geom_sf(data=road_centerlines, 
          alpha=0.1, 
          color="black", 
          size=1)+
  geom_sf(data=bus_routes,
          alpha=0.9, 
          color="#C96A52FF", 
          size=1)+
  labs(title="SunMetro Bus Network",
       caption="Data: Open Data El Paso")+
  mapTheme
```

## Ridership Data (2022)

Our client provided us with ridership data for the year 2022. Data was collected via sensors on a daily basis, recording number of on-boards and off-boards per stop and route. About 85% of buses were supplied with the sensors, thus the sensors had to be rotated to get the most accurate measures. 

```{r cleaning ridership data, warning=FALSE, message=FALSE, results=FALSE}
ridership <- read.csv(paste(data_folder, "/ridership.csv", sep = ''))

ridership$Date <- ridership$Date %>% 
  as.character() %>% 
  substring(2) %>% 
  as.Date(format = "%Y%m%d")

stops <- read.csv(paste(data_folder, "/stops.csv", sep = ''))
stops_sf <- stops %>% 
  st_as_sf(coords = c('stop_lon','stop_lat')) 

riderstops <- read.csv(paste(data_folder, "/riderstops1.csv", sep = ''))

df <- riderstops %>%
  na.omit(riderstops[, c("stop_lat", "stop_lon")]) %>% 
  st_as_sf(coords = c("stop_lon", "stop_lat"), crs = 4269)

df$longitude <- st_coordinates(df$geometry)[, "X"]
df$latitude <- st_coordinates(df$geometry)[, "Y"]

df$RT <- as.numeric(df$RT)

df <- df %>%
  mutate(
    type = case_when(
      RT == 2 ~ "Local",
      RT == 7 ~ "Local",
      RT == 10 ~ "Local",
      RT == 14 ~ "Local",
      RT == 15 ~ "Local",
      RT == 24 ~ "Local",
      RT == 25 ~ "Local",
      RT == 32 ~ "Local",
      RT == 33 ~ "Local",
      RT == 34 ~ "Local",
      RT == 35 ~ "Local",
      RT == 36 ~ "Local",
      RT == 37 ~ "Local",
      RT == 50 ~ "Local",
      RT == 51 ~ "Local",
      RT == 52 ~ "Local",
      RT == 53 ~ "Local",
      RT == 54 ~ "Local",
      RT == 58 ~ "Local",
      RT == 61 ~ "Local",
      RT == 62 ~ "Local",
      RT == 63 ~ "Local",
      RT == 64 ~ "Local",
      RT == 65 ~ "Local",
      RT == 66 ~ "Local",
      RT == 67 ~ "Local",
      RT == 68 ~ "Local",
      RT == 69 ~ "Local",
      RT == 72 ~ "Local",
      RT == 74 ~ "Local",
      RT == 86 ~ "Local",
      RT == 4 ~ "Circulator",
      RT == 8 ~ "Circulator",
      RT == 5 ~ "Express",
      RT == 6 ~ "Express",
      RT == 26 ~ "Express",
      RT == 59 ~ "Express",
      RT == 76 ~ "Express",
      RT == 11 ~ "Feeder",
      RT == 12 ~ "Feeder",
      RT == 13 ~ "Feeder",
      RT == 16 ~ "Feeder",
      RT == 19 ~ "Feeder",
      RT == 43 ~ "Feeder",
      RT == 44 ~ "Feeder",
      RT == 46 ~ "Feeder",
      RT == 56 ~ "Feeder",
      RT == 60 ~ "Feeder",
      RT == 84 ~ "Feeder",
      RT == 89 ~ "Feeder",
      RT == 205 ~ "BRIO",
      RT == 206 ~ "BRIO",
      RT == 207 ~ "BRIO",
      RT == 208 ~ "BRIO",
      RT == 17 ~ "Other",
      RT == 20 ~ "Other",
      RT == 21 ~ "Other",
      RT == 41 ~ "Other",
      RT == 82 ~ "Other",
      RT == 87 ~ "Other",
      RT == 500 ~ "Streetcar"
    )
  )

local <- df[df$type %in% "Local", ]

road_centerlines <- read_sf(paste(data_folder, "/EPCenterline.shp", sep = ''))
```

```{r find stops without ridership data, warning = FALSE, message = FALSE, results=FALSE}
RT_stop_avg <- df %>%
  group_by(RT, TP, longitude, latitude) %>%
  summarize(avg_ons = mean(Ons), 
            avg_offs = mean(Offs))

# RT_stop_avg <- RT_stop_avg %>%
#   mutate(
#     type = case_when(
#       RT == 2 ~ "Local",
#       RT == 7 ~ "Local",
#       RT == 10 ~ "Local",
#       RT == 14 ~ "Local",
#       RT == 15 ~ "Local",
#       RT == 24 ~ "Local",
#       RT == 25 ~ "Local",
#       RT == 32 ~ "Local",
#       RT == 33 ~ "Local",
#       RT == 34 ~ "Local",
#       RT == 35 ~ "Local",
#       RT == 36 ~ "Local",
#       RT == 37 ~ "Local",
#       RT == 50 ~ "Local",
#       RT == 51 ~ "Local",
#       RT == 52 ~ "Local",
#       RT == 53 ~ "Local",
#       RT == 54 ~ "Local",
#       RT == 58 ~ "Local",
#       RT == 61 ~ "Local",
#       RT == 62 ~ "Local",
#       RT == 63 ~ "Local",
#       RT == 64 ~ "Local",
#       RT == 65 ~ "Local",
#       RT == 66 ~ "Local",
#       RT == 67 ~ "Local",
#       RT == 68 ~ "Local",
#       RT == 69 ~ "Local",
#       RT == 72 ~ "Local",
#       RT == 74 ~ "Local",
#       RT == 86 ~ "Local",
#       RT == 4 ~ "Circulator",
#       RT == 8 ~ "Circulator",
#       RT == 5 ~ "Express",
#       RT == 6 ~ "Express",
#       RT == 26 ~ "Express",
#       RT == 59 ~ "Express",
#       RT == 76 ~ "Express",
#       RT == 11 ~ "Feeder",
#       RT == 12 ~ "Feeder",
#       RT == 13 ~ "Feeder",
#       RT == 16 ~ "Feeder",
#       RT == 19 ~ "Feeder",
#       RT == 43 ~ "Feeder",
#       RT == 44 ~ "Feeder",
#       RT == 46 ~ "Feeder",
#       RT == 56 ~ "Feeder",
#       RT == 60 ~ "Feeder",
#       RT == 84 ~ "Feeder",
#       RT == 89 ~ "Feeder",
#       RT == 205 ~ "BRIO",
#       RT == 206 ~ "BRIO",
#       RT == 207 ~ "BRIO",
#       RT == 208 ~ "BRIO",
#       RT == 17 ~ "Other",
#       RT == 20 ~ "Other",
#       RT == 21 ~ "Other",
#       RT == 41 ~ "Other",
#       RT == 82 ~ "Other",
#       RT == 87 ~ "Other",
#       RT == 500 ~ "Streetcar"
#     )
#   )

JS_gjson <- geojson_json(RT_stop_avg)
writeLines(JS_gjson, "JS.geojson")
```

We can see from the bar chart that BRIO routes are predominantly the most popular type of transit. Because of the fixed nature of BRIO routes, and political implications of bus transit design, we will primarily focus on local routes as part of our analysis. While some local routes experience relatively high ridership, we see total ridership peter out, with opportunity to increase ridership to underperforming routes.

```{r route summary, warning = FALSE, message = FALSE, results = FALSE}
RT_avg_sum <- df %>%
  group_by(RT) %>%
  summarize(avg_ons = mean(Ons), 
            avg_offs = mean(Offs),
            total_ons = sum(Ons),
            total_offs = sum(Offs)) %>%
  mutate(total_ridership = total_ons + total_offs) %>%
  mutate(
    type = case_when(
      RT == 2 ~ "Local",
      RT == 7 ~ "Local",
      RT == 10 ~ "Local",
      RT == 14 ~ "Local",
      RT == 15 ~ "Local",
      RT == 24 ~ "Local",
      RT == 25 ~ "Local",
      RT == 32 ~ "Local",
      RT == 33 ~ "Local",
      RT == 34 ~ "Local",
      RT == 35 ~ "Local",
      RT == 36 ~ "Local",
      RT == 37 ~ "Local",
      RT == 50 ~ "Local",
      RT == 51 ~ "Local",
      RT == 52 ~ "Local",
      RT == 53 ~ "Local",
      RT == 54 ~ "Local",
      RT == 58 ~ "Local",
      RT == 61 ~ "Local",
      RT == 62 ~ "Local",
      RT == 63 ~ "Local",
      RT == 64 ~ "Local",
      RT == 65 ~ "Local",
      RT == 66 ~ "Local",
      RT == 67 ~ "Local",
      RT == 68 ~ "Local",
      RT == 69 ~ "Local",
      RT == 72 ~ "Local",
      RT == 74 ~ "Local",
      RT == 86 ~ "Local",
      RT == 4 ~ "Circulator",
      RT == 8 ~ "Circulator",
      RT == 5 ~ "Express",
      RT == 6 ~ "Express",
      RT == 26 ~ "Express",
      RT == 59 ~ "Express",
      RT == 76 ~ "Express",
      RT == 11 ~ "Feeder",
      RT == 12 ~ "Feeder",
      RT == 13 ~ "Feeder",
      RT == 16 ~ "Feeder",
      RT == 19 ~ "Feeder",
      RT == 43 ~ "Feeder",
      RT == 44 ~ "Feeder",
      RT == 46 ~ "Feeder",
      RT == 56 ~ "Feeder",
      RT == 60 ~ "Feeder",
      RT == 84 ~ "Feeder",
      RT == 89 ~ "Feeder",
      RT == 205 ~ "BRIO",
      RT == 206 ~ "BRIO",
      RT == 207 ~ "BRIO",
      RT == 208 ~ "BRIO",
      RT == 17 ~ "Other",
      RT == 20 ~ "Other",
      RT == 21 ~ "Other",
      RT == 41 ~ "Other",
      RT == 82 ~ "Other",
      RT == 87 ~ "Other",
      RT == 500 ~ "Streetcar"
    )
  )
RT_avg_sum_st <- st_drop_geometry(RT_avg_sum)

transit_lines <- st_read(paste(data_folder, "/transit_lines.geojson", sep = ''))
merged <- merge(transit_lines, RT_avg_sum_st, by.x = "route_short_name", by.y = "RT")

RT_avg_sum_st <- RT_avg_sum_st[order(-RT_avg_sum_st$total_ridership),]

ggplot(RT_avg_sum_st, aes(y = total_ridership, x = reorder(factor(RT), -total_ridership), fill = type)) +
  geom_bar(stat = "identity") +
  xlab("Total Ridership") +
  ylab("Route") +
  scale_fill_manual(values = palette7, name="Type of Bus", expand=c(0.2, 0)) +
  labs(title="Total Ridership by Route and Type",
       caption="Data: El Paso Capital Improvements Department, 2022")+
  plotTheme+
  theme(axis.text.x = element_text(angle=90))
```

As the scatter plot indicates, there is a strong correlation between average on-board and off-board frequency. This indicates that in bus transit trips, the average rider may exhibit round-trip behavior, boarding the bus at point A to travel to point B and then returning to point A without any intermediate stops.

```{r scatterplot1, warning=FALSE, message=FALSE, results=FALSE}
RT_stop_avg_st <- st_drop_geometry(RT_stop_avg)

ggplot(RT_stop_avg_st, aes(x = avg_ons, y = avg_offs)) +
  geom_point() +
  labs(x = "Average on-boarding", 
       y = "Average off-boarding", 
       title = "Scatterplot of on-boarding and off-boarding", 
       subtitle="Average values grouped by route and stop information",
       caption="Data: El Paso Capital Improvements Department, 2022")+
  geom_smooth(method = lm, se=FALSE, colour = "#C96A52FF", size=1, )+
  geom_abline(intercept=0, slope=1, color="#C96A52FF", alpha=0.3, size=1, style='dashed')+
  plotTheme
```


```{r total offboards per route, warning = FALSE, message = FALSE, results=FALSE}
ggplot()+
  geom_sf(data=road_centerlines, 
          alpha=0.1, 
          color="black", 
          size=1)+
  geom_sf(data=merged,
          aes(color=total_offs),
          size=1)+
  scale_color_paletteer_c("grDevices::Red-Yellow", 
                          -1,
                          name="Sum")+
  labs(title="Total Offboards per route (2022)")+
  mapTheme
```

Highest onboarding and offboarding ridership is among BRIO lines. There seems to be a spatial pattern where lines that go further out into the suburbs experience less overall ridership.

## Leaflet Maps

The leaflet maps below are interactive to understand spatial distribution of current ridership patterns at a route and stop level.

```{r leaflet 1, warning = FALSE, message = FALSE, results=FALSE}
jenks_breaks <- classIntervals(RT_stop_avg$avg_ons, n = 8, style = "jenks")$brks

colors <- c("#7D0112FF", "#9A4221FF", "#BF7B42FF", "#E0BA79FF", "#F0E4B0FF", "#C0C0C0FF", "#787878FF", "#4B4B4BFF", "#000000FF")

# LL1 <- leaflet() %>%
#   addTiles() %>%
#   setView(lng = -106.485, lat = 31.763, zoom = 12) %>%
#   addCircleMarkers(data = RT_stop_avg, lng = ~longitude, lat = ~latitude, 
#                    radius = 5, 
#                    color = ~colors[cut(avg_ons, breaks = jenks_breaks)], 
#                    fillOpacity = 0.7,
#                    popup = paste(
#                      "Route: ", RT_stop_avg$RT, "<br>",
#                      "Stop: ", RT_stop_avg$TP, "<br>",
#                      "Average Onboarding: ", round(RT_stop_avg$avg_ons, digits = 2))) %>%
#   addLegend("bottomright", 
#             title = "Average Onboarding per stop & route", 
#             colors = colors, 
#             labels = c(sprintf("%.2f - %.2f", jenks_breaks[1], jenks_breaks[2]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[2], jenks_breaks[3]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[3], jenks_breaks[4]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[4], jenks_breaks[5]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[5], jenks_breaks[6]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[6], jenks_breaks[7]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[7], jenks_breaks[8]), 
#                        sprintf("%.2f - %.2f", jenks_breaks[8], jenks_breaks[9]), 
#                        sprintf(">%0.2f", jenks_breaks[9])),
#             opacity = 1) 
# 
# mapview(map=LL1, 
#         zcol="avg_ons", 
#         fill = c("#7D0112FF", "#9A4221FF", "#BF7B42FF", "#E0BA79FF", "#F0E4B0FF", "#C0C0C0FF", "#787878FF", "#4B4B4BFF", "#000000FF"), 
#         popup= list(Route = RT_stop_avg$RT,
#                     Stop = RT_stop_avg$TP,
#                     Average_Onboarding = round(RT_stop_avg$avg_ons, digits = 2)), 
#         layer.name = "Average Onboarding")

mapview(RT_stop_avg, 
        zcol = "avg_ons",
        col.regions = c("#7D0112FF", "#9A4221FF", "#BF7B42FF", "#E0BA79FF", "#F0E4B0FF"),
        layer.name = "Average Onboarding", 
        popup = list(Route = RT_stop_avg$RT, Stop = RT_stop_avg$TP, Avg_Ons = round(RT_stop_avg$avg_ons, digits = 2)))
```

```{r leaflet2, warning = FALSE, message = FALSE, results=FALSE}
jenks_breaksOffs <- classIntervals(dfRTx$avg_offs, n = 9, style = "jenks")$brks

LL2 <- leaflet(dfRTx) %>%
  addTiles() %>%
  setView(lng = -106.485, lat = 31.763, zoom = 12) %>%
  addCircleMarkers(data = dfRTx, lng = ~longitude, lat = ~latitude, 
                   radius = 5, 
                   color = ~colors(9)[cut(avg_offs, breaks = jenks_breaksOffs)], 
                   fillOpacity = 0.7,
                   popup = paste(
                     "Route: ", dfRTx$RT, "<br>",
                     "Stop: ", dfRTx$stop_desc, "<br>",
                     "Average Offboarding: ", round(dfRTx$avg_offs, digits = 2))) %>%
  addLegend("bottomright", 
            title = "Average Offboarding per stop & route", 
            colors = colors(9), 
            labels = c(sprintf("%.2f - %.2f", jenks_breaksOffs[1], jenks_breaksOffs[2]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[2], jenks_breaksOffs[3]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[3], jenks_breaksOffs[4]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[4], jenks_breaksOffs[5]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[5], jenks_breaksOffs[6]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[6], jenks_breaksOffs[7]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[7], jenks_breaksOffs[8]), 
                       sprintf("%.2f - %.2f", jenks_breaksOffs[8], jenks_breaksOffs[9]), 
                       sprintf(">%0.2f", jenks_breaksOffs[9])),
            opacity = 1) 
LL2
```

[LL2]("C:/Users/jtrum/pennmusa/MUSA8010/repository/ElPaso-Bus-Network/LL1.html")

# Feature Engineering

## Census Data (American Community Survey 2020)

First, we analyzed census data at the tract level from the 2020 American Community Survey. We particularly focused on demographic and socioeconomic indicators that we predicted to be correlated to transit ridership demand. Census variables were aggregated to the count per square mile, as this was the most intuitive measure for our hexbin.

```{r census vars, warning=FALSE, message=FALSE, results=FALSE}
censusvarsEP <- c(
  "B01001_001E", # ACS total Pop estimate
  "B01001I_001E", # Population - Hispanic or Latino 
  "B02001_002E", # Population - White alone
  "B02001_003E", # Population - Black or African American alone
  "B02001_004E", # Population - American Indian and Alaska Native alone
  "B02001_005E", # Population - Asian alone
  "B02001_006E", # Population - Native Hawaiian and Other Pacific Islander alone
  "B02001_007E", # Population - Some other race alone
  "B02001_008E", # Population - Two or more races
  "B19013_001E", # Median household income in the past 12 months (in 2019 inflation-adjusted dollars)
  "B25001_001E", # Total housing units
  "B25002_002E", # Occupancy status - Occupied housing units
  "B25024_001E", # Gross rent as a percentage of household income in the past 12 months
  "B25044_001E", # Vehicles available
  "B28005_001E", # Means of transportation to work by age
  "B28010_001E", # Commuting time to work (in minutes)
  "B10052_002E", # Disability
  "B06009_002E", # Less than high school
  "B06009_003E", # High School
  "B06009_004E", # Associates or equivalent
  "B06009_005E", # Bachelors
  "B06009_006E" # Graduate or prof. degree
)

elpaso <- get_acs(geography = "tract",
                  year = 2020, 
                  variables = censusvarsEP, 
                  geometry = T,
                  state = "TX", 
                  county = "El Paso", 
                  output = "wide") 

#vec to not divide by sqkm
dontdiv<- c("GEOID","NAME","medHHInc","grossRentPerInc","commuteToWork","geometry","area_sqmile")

elpaso <- elpaso %>%
  rename(
    totalPop = B01001_001E, 
    hlPop = B01001I_001E, 
    whitePop = B02001_002E, 
    blackPop = B02001_003E,
    aiPop = B02001_004E,
    asianPop = B02001_005E,
    nhPop = B02001_006E,
    otherRacePop = B02001_007E,
    twoPlusRacePop = B02001_008E,
    medHHInc = B19013_001E,
    totalHU = B25001_001E, 
    occupiedHU = B25002_002E, 
    grossRentPerInc = B25024_001E, 
    transByAge = B28005_001E,
    commuteToWork = B28010_001E,
    lessThanHS = B06009_002E,
    highSchool = B06009_003E,
    associatesDeg = B06009_004E,
    bachelorDeg = B06009_005E,
    professionalDeg = B06009_006E,
    disability = B10052_002E) %>%
  mutate(area_sqmile = st_area(geometry)/2590000
  ) %>%  st_as_sf(crs = 4269) %>%
  mutate_at(vars(-dontdiv), funs(as.numeric(./area_sqmile)))

elpaso <- elpaso %>%
  dplyr::select(-c("B01001_001M", "B01001I_001M", "B02001_002M", "B02001_003M", "B02001_004M", "B02001_005M", "B02001_006M", "B02001_007M", "B02001_008M", "B19013_001M", "B25001_001M", "B25002_002M", "B25024_001M", "B25044_001M", "B28005_001M", "B28010_001M","B10052_002M", "B06009_002M", "B06009_003M", "B06009_004M", "B06009_005M", "B06009_006M"))
```

```{r census plot 1, warning=FALSE, message=FALSE, results=FALSE}
censusvarsEP <- c(
  "B01001_001E", # ACS total Pop estimate
  "B01001I_001E", # Population - Hispanic or Latino 
  "B02001_002E", # Population - White alone
  "B02001_003E", # Population - Black or African American alone
  "B02001_004E", # Population - American Indian and Alaska Native alone
  "B02001_005E", # Population - Asian alone
  "B02001_006E", # Population - Native Hawaiian and Other Pacific Islander alone
  "B02001_007E", # Population - Some other race alone
  "B02001_008E", # Population - Two or more races
  "B19013_001E", # Median household income in the past 12 months (in 2019 inflation-adjusted dollars)
  "B25001_001E", # Total housing units
  "B25002_002E", # Occupancy status - Occupied housing units
  "B25024_001E", # Gross rent as a percentage of household income in the past 12 months
  "B25044_001E", # Vehicles available
  "B28005_001E", # Means of transportation to work by age
  "B28010_001E", # Commuting time to work (in minutes)
  "B10052_002E", # Disability
  "B06009_002E", # Less than high school
  "B06009_003E", # High School
  "B06009_004E", # Associates or equivalent
  "B06009_005E", # Bachelors
  "B06009_006E" # Graduate or prof. degree
)

ep <- get_acs(geography = "tract",
              year = 2020, 
              variables = censusvarsEP, 
              geometry = T,
              state = "TX", 
              county = "El Paso", 
              output = "wide") 

ep <- ep %>%
  rename(
    totalPop = B01001_001E, 
    hlPop = B01001I_001E, 
    whitePop = B02001_002E, 
    blackPop = B02001_003E,
    aiPop = B02001_004E,
    asianPop = B02001_005E,
    nhPop = B02001_006E,
    otherRacePop = B02001_007E,
    twoPlusRacePop = B02001_008E,
    medHHInc = B19013_001E,
    totalHU = B25001_001E, 
    occupiedHU = B25002_002E, 
    grossRentPerInc = B25024_001E, 
    transByAge = B28005_001E,
    commuteToWork = B28010_001E,
    lessThanHS = B06009_002E,
    highSchool = B06009_003E,
    associatesDeg = B06009_004E,
    bachelorDeg = B06009_005E,
    professionalDeg = B06009_006E,
    disability = B10052_002E)

elpasopct <- ep %>%
  mutate(
    whitePopPct = (whitePop/totalPop)*100,
    hlPopPct = (hlPop/totalPop)*100,
    asianPopPct = (asianPop/totalPop)*100,
    blackPopPct = (blackPop/totalPop)*100
  )


grid.arrange(ncol=2,
             ggplot()+
               geom_sf(data=elpasopct, aes(fill=whitePopPct), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% White population",
                    caption="Data: ACS, 2020")+
               mapTheme,
             ggplot()+
               geom_sf(data=elpasopct, aes(fill=hlPopPct), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Hispanic/Latino population",
                    caption="Data: ACS, 2020")+
               mapTheme,
             ggplot()+
               geom_sf(data=elpasopct, aes(fill=blackPopPct), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Black population",
                    caption="Data: ACS, 2020")+
               mapTheme,
             ggplot()+
               geom_sf(data=elpasopct, aes(fill=asianPopPct), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Asian population",
                    caption="Data: ACS, 2020")+
               mapTheme
)
```

```{r cen plot2, warning=FALSE, message=FALSE, results=FALSE}
elpasopct <- ep %>%
  mutate(
    occupiedHUPct = (occupiedHU/totalHU)*100,
    vacantHUPct = ((totalHU-occupiedHU)/totalHU)*100
  )


ggplot()+
  geom_sf(data=elpasopct, aes(fill=vacantHUPct), color=NA)+
  scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
  labs(title="Vacant Housing Units per sq mile",
       subtitle="El Paso, TX (2020)",
       caption="Data: ACS")+
  mapTheme

```
```{r cen plot3, warning=FALSE, message=FALSE, results=FALSE}
ggplot()+
  geom_sf(data=elpaso, aes(fill=medHHInc), color=NA)+
  scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
  labs(title="Median Household Income",
       subtitle="El Paso, TX (2020)",
       caption="Data: ACS, 2020")+
  mapTheme
```


## National Walkability Index (2019)

```{r nwi data, warning=FALSE, message=FALSE,}
nwi <- read_csv(paste(data_folder, "/nwi2019.csv", sep = '')) %>%
  dplyr::filter(CBSA_Name == "El Paso, TX") %>%
  dplyr::select(c("OBJECTID",
                  "GEOID10",
                  "TRACTCE",
                  "BLKGRPCE",
                  "TotPop",
                  "CountHU", # number of housing units
                  "P_WrkAge", # percent working age pop. (18-64)
                  "HH", # households
                  "Pct_AO0", # % of HH owning 0 vehicles
                  "Pct_AO1", # % of HH owning 1 vehicle
                  "Pct_AO2p", # % of HH owning 2+ vehicles
                  "R_PCTLOWWAGE", # % of low wage workers
                  "D1C", # employment density
                  "D2R_JOBPOP", # jobs to population balance
                  "D2B_E8MIXA", # employment mix
                  "D2A_EPHHM", # employment + household mix
                  "D3B", # intersection density
                  "D4A", # distance from population-weighted centroid to nearest transit stop
                  "D5AR", # regional accessibility for access to jobs
                  "D5BR", # destination accessibility via transit
  ))

nwi$GEOID <- paste0(substr(nwi$GEOID10, 1, 5), "0", sprintf("%05d", nwi$TRACTCE), nwi$BLKGRPCE)

blocks <-read_sf(paste(data_folder, "/tl_2019_48_bg.shp", sep = '')) %>%
  dplyr::filter(COUNTYFP == 141) %>%
  dplyr::select(-c("STATEFP", "COUNTYFP", "TRACTCE", "BLKGRPCE", "NAMELSAD", "MTFCC", "FUNCSTAT", "ALAND", "AWATER", "INTPTLAT", "INTPTLON"))

nwi_bg <- left_join(nwi, blocks, by = "GEOID")

nwi_bg <- st_as_sf(nwi_bg)

nwi_bg %>%
  rename(
    totalPop = TotPop,
    housingUnits = CountHU,
    pctWorkingAge = P_WrkAge,
    housingUnits = CountHU,
    pct0Car = Pct_AO0,
    pct1Car = Pct_AO1,
    pct2Car = Pct_AO2p,
    pctLowWage = R_PCTLOWWAGE,
    employmentDensity = D1C,
    jobsPopBalance = D2R_JOBPOP,
    employmentMix = D2B_E8MIXA,
    employmentHHMix = D2A_EPHHM,
    intersectionDensity = D3B,
    nearestTransit = D4A,
    jobAccessibility = D5AR,
    destinationAccessibility = D5BR
  ) %>%
  dplyr::select(-c("OBJECTID",
                   "GEOID10",
                   "TRACTCE",
                   "BLKGRPCE",))
grid.arrange(ncol=3,
             ggplot()+
               geom_sf(data=nwi_bg, aes(fill=Pct_AO0), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Access to No Vehicle",
                    subtitle="El Paso, TX (2019)",
                    caption="Data: United States Census Bureau, 2019")+
               mapTheme,
             ggplot()+
               geom_sf(data=nwi_bg, aes(fill=Pct_AO1), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Access to 1 Vehicle",
                    subtitle="El Paso, TX (2019)")+
               mapTheme,
             ggplot()+
               geom_sf(data=nwi_bg, aes(fill=Pct_AO2p), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="% Access to 2+ Vehicles",
                    subtitle="El Paso, TX (2019)")+
               mapTheme)
```

```{r job pop, warning=FALSE, message=FALSE,}
ggplot()+
  geom_sf(data=nwi_bg, aes(fill=D2R_JOBPOP), color=NA)+
  scale_fill_paletteer_c("grDevices::Red-Yellow", -1, name="%")+
  labs(title="Jobs to Population Balance",
       subtitle="El Paso, TX (2019)",
       caption="Data: National Walkability Index, 2019")+
  mapTheme
```

```{r access data, warning=FALSE, message=FALSE,}
grid.arrange(ncol=3,
             ggplot()+
               geom_sf(data=nwi_bg%>% filter(D4A > 0), aes(fill=D4A), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="Distance from centroid \nto nearest transit stop",
                    subtitle="El Paso, TX (2019)",
                    caption="Data: National Walkability Index, 2019")+
               mapTheme,
             ggplot()+
               geom_sf(data=nwi_bg %>% filter(D5AR > 0), aes(fill=D5AR), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="Regional Accessibility \nMetric - Job Access",
                    subtitle="El Paso, TX (2019)")+
               mapTheme,
             ggplot()+
               geom_sf(data=nwi_bg%>% filter(D5BR > 0), aes(fill=D5BR), color=NA)+
               scale_fill_paletteer_c("grDevices::Red-Yellow", -1)+
               labs(title="Transit Destination \nAccessibility",
                    subtitle="El Paso, TX (2019)")+
               mapTheme)
```

## Open Street Map Amenities


## Jobs Data



## Existing Bike Lanes + Other Roadway Infrastructure


```{r open data el paso loading}
road_centerlines <- read_sf(paste(data_folder, "/EPCenterline.shp", sep = ''))

bike_lanes <- read_sf(paste(data_folder, "/BikeLanesFinal.shp", sep = ''))
bike_lanesEx <- bike_lanes[bike_lanes$Status != "PROPOSED", ]
bike_lanesPr <- bike_lanes[bike_lanes$Status != "EXISTING", ]

parks <- read_sf(paste(data_folder, "/ParkandRecreationFacilities.shp", sep = ''))

#schools <- read_sf(paste(data_folder, "/Schools.shp", sep = ''))

#futureLU <- read_sf(paste(data_folder, "/FutureLandUse.shp", sep = ''))

TIRZ <- read_sf(paste(data_folder, "/TIRZ.shp", sep = ''))

elpaso_outline <- elpaso %>% st_union() %>% sf::st_cast()

# Transform the bike lanes data to match the CRS of the outline data
bike_lanesEx <- st_transform(bike_lanesEx, crs = st_crs(elpaso_outline))

# Calculate the distance between each point in the outline data to the nearest point on the bike lanes data
distance <- st_distance(elpaso_outline, bike_lanesEx, line_to_point = TRUE)

# Add the distance values as a new column to the outline data
elpaso_outline$distance_to_bike_lane <- distance

# Plot a heatmap of the distance values
ggplot() +
  geom_sf(data = elpaso_outline, aes(fill = distance_to_bike_lane)) +
  scale_fill_gradient(low = "blue", high = "red") +
  theme_void()

```


```{r bike lanes}
bikeplot <- ggplot()+
  geom_sf(data=road_centerlines, alpha=0.1)+
  geom_sf(data=bike_lanesEx, size=1, color="#8E063BFF")+
  labs(title="Bike Lanes in \nEl Paso, Texas",
       caption="Data: Open Data El Paso",
       )+
  theme()+
  mapTheme
```

## Parks and Recreation Facilities

```{r parks}
parks$Type <- "park"

parkplot <- ggplot()+
  geom_sf(data=road_centerlines, alpha=0.1)+
  geom_sf(data=parks, 
          size=1, 
          alpha=.7, 
          color="#C96A52FF")+
  labs(title="Parks in \nEl Paso, Texas",
       )+
  mapTheme
```

## Tax Increment Reinvestment Zones

```{r}
TIRZ$TIRZ = "TIRZ"
tirzplot <- ggplot()+
  geom_sf(data=road_centerlines, alpha=0.1)+
  geom_sf(data=TIRZ, size=1, color="#C96A52FF", alpha=.7)+
  labs(title="Tax Increment \nReinvestment Zones",
       )+
  mapTheme
```

## Public Improvement Districts

```{r}
grid.arrange(ncol=3, bikeplot, parkplot, tirzplot)
```



## Open Street Map

```{r osm amenities}
bbox <- c(left = -106.6435, bottom = 31.6815, right = -106.1845, top = 31.9865)

el_paso_amenities <- osmdata::osmdata_sf(
  bbox = bbox,
  type = "amenity"
)

# Print the first few rows of the resulting data
head(el_paso_amenities$osm_points)

```

# Modeling

We are building a zero-inflated Poisson regression model, aggregating our ridership data and engineered features into hexbins, to predict latent demand for bus services.

```{r}

elpaso_outline <- elpaso %>% st_union() %>% sf::st_cast()

hex <- st_make_grid(elpaso_outline, cellsize = .01, crs = 4269,  square = F)  %>%  st_sf() 

hex <- hex[elpaso,] %>%
  mutate(uniqueID = rownames(.))
```

```{r}

riderstops_sf <- read_csv(paste(data_folder, "/riderstops1.csv", sep = '')) %>%
  filter(!is.na(stop_lat)) %>%
  st_as_sf(coords = c('stop_lon', 'stop_lat'), crs = 4269) 

stop_riders_agg <- riderstops_sf %>% group_by(TP) %>% summarise(ridership = sum(Ons) + sum(Offs))

ridership_net <- stop_riders_agg %>% 
  dplyr::select(ridership) %>% 
  aggregate(., hex, sum) %>%
  mutate(ridership = replace_na(ridership, 0))

```


```{r get el paso census data}
censusvarsEP <- c(
  "B01001_001E", # ACS total Pop estimate
  "B01001I_001E", # Population - Hispanic or Latino 
  "B02001_002E", # Population - White alone
  "B02001_003E", # Population - Black or African American alone
  "B02001_004E", # Population - American Indian and Alaska Native alone
  "B02001_005E", # Population - Asian alone
  "B02001_006E", # Population - Native Hawaiian and Other Pacific Islander alone
  "B02001_007E", # Population - Some other race alone
  "B02001_008E", # Population - Two or more races
  "B19013_001E", # Median household income in the past 12 months (in 2019 inflation-adjusted dollars)
  "B25001_001E", # Total housing units
  "B25002_002E", # Occupancy status - Occupied housing units
  "B25024_001E", # Gross rent as a percentage of household income in the past 12 months
  "B25044_001E", # Vehicles available
  "B28005_001E", # Means of transportation to work by age
  "B28010_001E", # Commuting time to work (in minutes)
  "B10052_002E", # Disability
  "B06009_002E", # Less than high school
  "B06009_003E", # High School
  "B06009_004E", # Associates or equivalent
  "B06009_005E", # Bachelors
  "B06009_006E" # Graduate or prof. degree
)

elpaso <- get_acs(geography = "tract",
                  year = 2020, 
                  variables = censusvarsEP, 
                  geometry = T,
                  state = "TX", 
                  county = "El Paso", 
                  output = "wide") 

#vec to not divide by sqkm
dontdiv<- c("GEOID","NAME","medHHInc","grossRentPerInc","commuteToWork","geometry","area_sqmile")

elpaso <- elpaso %>%
  rename(
    totalPop = B01001_001E, 
    hlPop = B01001I_001E, 
    whitePop = B02001_002E, 
    blackPop = B02001_003E,
    aiPop = B02001_004E,
    asianPop = B02001_005E,
    nhPop = B02001_006E,
    otherRacePop = B02001_007E,
    twoPlusRacePop = B02001_008E,
    medHHInc = B19013_001E,
    totalHU = B25001_001E, 
    occupiedHU = B25002_002E, 
    grossRentPerInc = B25024_001E, 
    transByAge = B28005_001E,
    commuteToWork = B28010_001E,
    lessThanHS = B06009_002E,
    highSchool = B06009_003E,
    associatesDeg = B06009_004E,
    bachelorDeg = B06009_005E,
    professionalDeg = B06009_006E,
    disability = B10052_002E) %>%
  mutate(area_sqmile = st_area(geometry)/2590000
  ) %>%  st_as_sf(crs = 4269) %>%
  mutate_at(vars(-dontdiv), funs(as.numeric(./area_sqmile)))


```

```{r make_hex_net}
busroutes <-  read_sf(paste(data_folder, "/transit_lines.geojson", sep = '')) %>% st_transform(crs = 4269)

roads <- read_sf(paste(data_folder, "/EPCenterline.shp", sep = '')) %>% st_transform(crs = 4269)

#ask alex about this map


futureLU <- read_sf(paste(data_folder, "/FutureLandUse.shp", sep = '')) %>% st_transform(crs = 4269)  

futureLU_crop <- futureLU %>% st_crop(y = st_bbox(busroutes))

# ggplot()+
#    geom_sf(data = futureLU, aes(fill = COMMENTS))+
#    geom_sf(data = roads)+
#    geom_sf(data = busroutes, color = 'red')



excludeLU <- c("Fort Bliss Military","Fort Bliss Mixed Use (Airport)","Preserve","Industrial and/or Railyards","Remote","Military Reserve")


exclude_area <-  futureLU_crop %>% filter(COMMENTS %in% excludeLU) %>% st_union()



elpaso_outline <- elpaso %>% st_union() %>% st_sf() %>% st_crop(y = st_bbox(busroutes)) %>% st_difference(exclude_area)


hex <- st_make_grid(elpaso_outline, cellsize = .01, crs = 4269,  square = F) %>% st_sf() 

hex <- hex[elpaso_outline,] %>%
  mutate(uniqueID = rownames(.))

ggplot(hex)+
  geom_sf()+
  mapTheme

```



```{r target variable into net}
data_folder <- file.path(here() %>% dirname(), 'data')

riderstops_sf <- read_csv(paste(data_folder, "/riderstops1.csv", sep = '')) %>%
  filter(!is.na(stop_lat)) %>%
  st_as_sf(coords = c('stop_lon', 'stop_lat'), crs = 4269) 

stop_riders_agg <- riderstops_sf %>% group_by(TP) %>% summarise(ridership = sum(Ons) + sum(Offs))


ridership_net <- stop_riders_agg %>% 
  dplyr::select(ridership) %>% 
  aggregate(., hex, sum) %>%
  mutate(ridership = replace_na(ridership, 0),
         uniqueID = rownames(.))

```

```{r rider hex dist}
riders <- st_drop_geometry(ridership_net)

ggplot(riders %>% filter(ridership > 0), aes(x=ridership)) + 
  geom_histogram(color=NA, fill="#C96A52FF",bins=100)+
  labs(title="Total ridership per hexbin", 
       subtitle = "Hexbins with 0 ridership unaccounted", y = "", x ="Total Ridership (2022)")+
  plotTheme
```

```{r}
# Load required packages
library(dplyr)
library(kableExtra)

# Create table
riders_table <- riders %>%
  summarise_all(list(Total = ~n(), Count_Ridership_0 = ~sum(ridership == 0))) %>%
  kable(align = "c") %>%
  kable_styling("bordered", full_width=F)


# Print table
riders_table

```

```{r}
ggplot(ridership_net %>% st_crop(y= elpaso_outline) %>% filter(ridership > 0))+
  geom_sf(aes(fill = ridership), color = NA)+
  geom_sf(data = ridership_net %>% st_crop(y= elpaso_outline) %>%  filter(ridership == 0), color = NA, fill = '#fbfae4')+
  scale_fill_paletteer_c("grDevices::Red-Yellow", -1, labels = comma, name='Total Ridership')+
  labs(title = "Ridership Per Hexbin", subtitle = "Downtown has an exceptional amount of ridership")+
  mapTheme
```

```{r}
ggplot(ridership_net %>% st_crop(y= elpaso_outline) %>% filter(ridership > 0))+
  geom_sf(aes(fill = whitePop), color = NA)+
  geom_sf(data = census_hex %>% st_crop(y= elpaso_outline) %>%  filter(ridership == 0), color = NA, fill = '#fbfae4')+
  scale_fill_paletteer_c("grDevices::Red-Yellow", -1, labels = comma, name='Total Ridership')+
  labs(title = "Ridership Per Hexbin", subtitle = "Downtown has an exceptional amount of ridership")+
  mapTheme
```

```{r create census hex}

#https://lehd.ces.census.gov/data/lodes/LODES7/LODESTechDoc7.5.pdf

#get lhodes work place data
tx_work <- grab_lodes(state = "tx", year = 2019, lodes_type = "wac", job_type = "JT01", 
                      segment = "S000", state_part = "main", agg_geo = "tract") %>% 
  rename(total_jobs = C000,
         age_29_or_younger = CA01,
         age_30_to_54 = CA02,
         age_55_or_older = CA03,
         monthly_income_1250_or_less = CE01,
         monthly_income_1251_to_3333 = CE02,
         monthly_income_3334_or_more = CE03,
         NAICS11 = CNS01,
         NAICS21 = CNS02,
         NAICS22 = CNS03,
         NAICS23 = CNS04,
         NAICS31_33 = CNS05,
         NAICS42 = CNS06,
         NAICS44_46 = CNS07,
         NAICS48_49 = CNS08,
         NAICS51 = CNS09,
         NAICS52 = CNS10,
         NAICS53 = CNS11,
         NAICS54 = CNS12,
         NAICS55 = CNS13,
         NAICS56 = CNS14,
         NAICS61 = CNS15,
         NAICS62 = CNS16,
         NAICS71 = CNS17,
         NAICS72 = CNS18,
         NAICS81 = CNS19,
         NAICS92 = CNS20,
         white_work = CR01,
         black_work = CR02,
         native_american_work = CR03,
         asian_work = CR04,
         pacific_work = CR05,
         mixed_race_work = CR07,
         not_hispanic_work = CT01,
         hispanic_work = CT02,
         male_work = CS01,
         female_work = CS02) %>% select(-starts_with("C"))
#merge to census tracts data
elpaso_work <- left_join(elpaso, tx_work, by = c('GEOID' = 'w_tract')) %>% st_sf() %>%
  mutate_at(colnames(tx_work)[4:length(colnames(tx_work))], funs(as.numeric(./area_sqmile)))

#add to hex
census_hex <- hex %>% st_centroid() %>% st_join(elpaso_work, join=st_within) %>% 
  st_drop_geometry() %>% 
  full_join(., hex) %>% st_sf()


```

```{r}
#tring another way

#hex_join <- st_intersection(hex, elpaso_work) %>% group_by(uniqueID) %>% 
# summarize()

#ggplot(hex_join)+
# geom_sf()
```


```{r walkabiity features}
walkscore <- read_sf(paste(data_folder, "/nwi_bg.geojson", sep = '')) %>% rename(
  totalPop_walk = totalPop
)

walk_hex <- hex %>% st_centroid() %>% st_join(walkscore, join=st_within)

```

```{r make final hex}
final_hex <- left_join(ridership_net, st_drop_geometry(census_hex), by = "uniqueID") %>% 
  left_join(st_drop_geometry(walk_hex), by = "uniqueID") %>% replace(is.na(.), 0)

```

```{r feature mapping and scatterplot}



inde_var <- "total_jobs"



scat <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(inde_var)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs\n",inde_var), y = 'Ridership', x = inde_var)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')

map <- final_hex %>%
  ggplot()+
  geom_sf(aes(fill = get(inde_var)), color =NA)+
  paletteer::scale_fill_paletteer_c("grDevices::Red-Yellow", -1, labels= comma)+
  labs(fill = inde_var)+
  theme(legend.position = 'right')+
  mapTheme

plot_grid(scat, map, rel_widths = c(1,1.3))
```

```{r}
ind2 <- 'white_work' 
ind3 <- 'NAICS54'
ind4 <- 'monthly_income_1250_or_less' 
ind5 <- 'age_29_or_younger'

scat2 <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(ind2)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs\n",ind2), y = 'Ridership', x = ind2)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')
scat3 <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(ind3)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs\n",ind3), y = 'Ridership', x = ind3)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')
scat4 <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(ind4)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs\n",ind4), y = 'Ridership', x = ind4)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')
scat5 <- final_hex %>% st_drop_geometry() %>% 
  ggplot(aes(y = ridership, x = get(ind4)))+
  geom_point(alpha = .5)+
  scale_x_continuous(labels = comma)+
  scale_y_continuous(labels = comma)+
  theme_bw()+
  labs(title = paste("Hex Ridership vs\n",ind5), y = 'Ridership', x = ind5)+
  stat_cor(method = "pearson")+
  geom_smooth(method = 'lm', se = F, color = 'red', linetype= 'dashed')

plot_grid(scat, scat2, scat3, scat4, scat5, rel_widths = c(1,1))
```


```{r modeling}

lhodes_vars <-c(colnames(tx_work)[5:length(colnames(tx_work))])
census_vars <- c(colnames(elpaso)[!colnames(elpaso) %in% c("GEOID","NAME")] )
walkscore_vars <- c(colnames(walk_hex))

input <- final_hex %>% select(ridership, lhodes_vars, census_vars, walkscore_vars) %>% st_drop_geometry()

m1 <- lm(formula = ridership ~ .,
         data = input)

m1 %>% summary()

```

## Training and Testing

```{r}
set.seed(987)

trainIndex <- createDataPartition(y=paste(input$ridership), 
                                  p = .65,
                                  list = FALSE,
                                  times = 1)
rTrain <- input[ trainIndex,]
rTest <- input[-trainIndex,]
```

```{r}
originalModel <- lm(ridership ~ .,
                    data=rTrain)
summary(originalModel)
```

